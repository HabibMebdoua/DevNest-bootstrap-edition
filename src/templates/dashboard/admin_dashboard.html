{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">

    <!-- Start Edit Modal -->
    {% for project in projects %}
    <div class="modal fade" id="editModal{{ project.id }}" tabindex="-1" aria-labelledby="editModalLabel{{ project.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                
                <!-- Header -->
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel{{ project.id }}">
                        {{ project.title }} - تعديل طلب المشروع
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>

                <!-- Body -->
                <div class="modal-body">
                    <form action="{% url 'admin_edit_project' project.pk %}" method="POST" class="row g-3">
                        {% csrf_token %}

                        <!-- حالة المشروع -->
                        <div class="col-12">
                            <label class="form-label">حالة المشروع</label>
                            <select name="state" class="form-select">
                                <option value="inprogress" {% if project.state == 'inprogress' %}selected{% endif %}>قيد التطوير</option>
                                <option value="completed" {% if project.state == 'completed' %}selected{% endif %}>مكتمل</option>
                                <option value="pending" {% if project.state == 'pending' %}selected{% endif %}>معلق</option>
                            </select>
                        </div>

                        <!-- تاريخ التسليم -->
                        <div class="col-12">
                            <label class="form-label">تاريخ التسليم</label>
                            <input type="date" name="delivery_date" value="{{ project.delivery_date|date:'Y-m-d' }}" class="form-control">
                        </div>

                        <!-- Footer -->
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">حفظ</button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
    {% endfor %}
    <!-- End Edit Modal -->

    <!-- العنوان -->
    <h1 class="h3 fw-bold text-secondary mb-4">لوحة تحكم الأدمن</h1>

    <!-- Filter Form -->
    <form action="" method="get" class="row g-3 mb-5">
        {% csrf_token %}
        <div class="col-md-3">
            {{ project_filter.form.title }}
        </div>
        <div class="col-md-3">
            {{ project_filter.form.state }}
        </div>
        <div class="col-md-3">
            {{ project_filter.form.created_at }}
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">بحث</button>
        </div>
    </form>

    <!-- إحصائيات -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">عدد المشاريع</h5>
                    <p class="display-6 text-primary mt-3">{{ projects.count }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">عدد المشاريع قيد التطوير</h5>
                    <p class="display-6 text-success mt-3">{{ projects_inprogress }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">عدد الطلبات المسلمة</h5>
                    <p class="display-6 text-danger mt-3">{{ projects_completed }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- جدول المشاريع -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-4">إدارة المشاريع</h5>
            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center">
                    <thead class="table-light">
                        <tr>
                            <th>عنوان المشروع</th>
                            <th>معلومات صاحب المشروع</th>
                            <th>حالة المشروع</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}
                        <tr>
                            <td class="text-start">{{ project.title }}</td>
                            <td>{{ project.owner.username }} - {{ project.owner.phone_number }} - {{ project.owner.email }}</td>
                            <td>{{ project.state }}</td>
                            <td>
                                <!-- زر التعديل -->
                                <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#editModal{{ project.id }}">
                                    <i class="ri-edit-line me-1"></i> تعديل
                                </button>
                                <!-- زر الحذف -->
                                <a href="{% url 'admin_delete_project' project.id %}" class="btn btn-sm btn-danger">
                                    حذف
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">لا توجد مشاريع لعرضها</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}
